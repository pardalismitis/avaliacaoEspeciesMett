---
title: "Organização"
output:
  pdf_document: default
  html_notebook: default
---

Desenvolvimento: Fernando Lima, D.Sc.

## PREPARAÇÃO

### PACOTES

```{r pacotes, message=FALSE}
rm(list = ls(all = TRUE))
source("../funcoes/pacotes.R")
pacotes("here", "readr", "dplyr", "stringr", "sf", "tibble")
```

### CARREGAR ÁREA DE ABRANGÊNCIA

```{r}
# vetor
# options
options(timeout = 1e6)
sf::sf_use_s2(FALSE)

areaAbrangenciaConexao <- sf::st_read(
  here(
    "01_dadosDeEntrada", "geo/area_de_abrangencia1_cma_4674.shp"
    )
  )
```

CARREGAR FUNÇÕES DE LEITURA DE ARQUIVOS

```{r}
read_csv_file <- function(filename) {
  readr::read_csv(
    here(
    "01_dadosDeEntrada", filename
    ),
    show_col_types = FALSE
    )
}

read_csv_tab <- function(filename) {
  readr::read_delim(
    here(
    "01_dadosDeEntrada", filename
    ),
    delim = "\t",
    show_col_types = FALSE
    )
}

read_csv_file2 <- function(filename) {
  readr::read_csv2(
    here(
      "01_dadosDeEntrada", filename
      ),
    show_col_types = FALSE
    )
}
```

## Atlantic-Amphibians

```{r}
# Read and process sites data
atlanticAmphibiansSites <- read_csv_file(
  "atlantic_amphibians/ATLANTIC_AMPHIBIANS_sites.csv"
  ) %>%
  select(
    id,
    latitude,
    longitude
    ) %>%
  na.omit()
# Read and process species data
atlanticAmphibiansSpecies <- read_csv_file(
  "atlantic_amphibians/ATLANTIC_AMPHIBIANS_species.csv"
  ) %>%
  select(
    id,
    order,
    family,
    genus,
    valid_name
    ) %>%
  mutate(
    grupo = "Anfíbios"
  ) %>%
  na.omit()

# Join sites and species data
atlanticAmphibians <- atlanticAmphibiansSpecies %>%
  left_join(
    atlanticAmphibiansSites,
    by = "id"
    ) %>%
  rename(
    ordem = order,
    familia = family,
    genero = genus,
    especie = valid_name
    )
# Read references data
atlanticAmphibiansReferences <- read_csv("atlantic_amphibians/ATLANTIC_AMPHIBIANS_references.csv")
```

### Filtrar para a área de estudo

```{r}
atlanticAmphibiansVetor <- atlanticAmphibians %>% 
    tidyr::drop_na(longitude, latitude) %>% 
    dplyr::mutate(lon = longitude,
                  lat = latitude) %>% 
    dplyr::filter(lon > -180 & lon < 180) %>% 
    dplyr::filter(lat > -90 & lat < 90) %>% 
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4674)
    
plot(atlanticAmphibiansVetor$geometry, pch = 20)

CMA_atlanticAmphibians <- atlanticAmphibiansVetor[areaAbrangenciaConexao, ] %>% 
  tibble::rowid_to_column()

plot( atlanticAmphibiansCMA$geometry, pch = 20)
```

### Exportar arquivos `*.csv`

```{r}
readr::write_csv(
  atlanticAmphibians,
  here(
    "03_dadosDeSaida", "atlanticAmphibians.csv"
    )
  )

readr::write_csv(
  CMA_atlanticAmphibians,
  here(
    "03_dadosDeSaida", "CMA_atlanticAmphibians.csv"
    )
  )
```

## Atlantic Ants

```{r}
atlanticAnts <- read_csv_tab(
  "atlantic_ants/ATLANTIC_ANTS_dataset.txt"
  ) %>%
  mutate(
    speciesName = paste(Genus, Species),
    grupo = "Formigas"
    ) %>%
  filter(
    Morphospecies == 0,
    Start.year > 2002
  ) %>%
  select(
    AANTS.code,
    Genus,
    speciesName,
    grupo,
    Latitude.y,
    Longitude.x
    ) %>%
  na.omit() %>%
  rename(
    id = AANTS.code,
    genero = Genus,
    especie = speciesName,
    latitude = Latitude.y,
    longitude = Longitude.x
    )
```

### Filtrar para a área de estudo

```{r}
atlanticAntsVetor <- atlanticAnts %>% 
    tidyr::drop_na(
      longitude,
      latitude
      ) %>% 
    dplyr::mutate(
      lon = longitude,
      lat = latitude
      ) %>% 
    dplyr::filter(
      lon > -180 & lon < 180
      ) %>% 
    dplyr::filter(
      lat > -90 & lat < 90
      ) %>% 
  sf::st_as_sf(
    coords = c("lon", "lat"), crs = 4674)
    
plot(atlanticAntsVetor$geometry, pch = 20)

CMA_atlanticAnts <- atlanticAntsVetor[areaAbrangenciaConexao, ] %>% 
  tibble::rowid_to_column()

plot(CMA_atlanticAnts$geometry, pch = 20)
```

### Exportar arquivos `*.csv`

```{r}
readr::write_csv(atlanticAnts, here("03_dadosDeSaida", "atlanticAnts.csv"))
readr::write_csv(CMA_atlanticAnts, here("03_dadosDeSaida", "CMA_atlanticAnts.csv"))
```

## Atlantic Birds

```{r}
atlanticBirdsQualitative <- read_csv_file(
  "atlantic_birds/ATLANTIC_BIRDS_qualitative.csv"
  ) %>%
  filter(
    Year > 2002
    ) %>%
  select(
    Record_id,
    Species,
    Latitude_y,
    Longitude_x
    ) %>%
  na.omit() %>%
  rename(
    id = Record_id,
    especie = Species,
    latitude = Latitude_y,
    longitude = Longitude_x
    )

atlanticBirdsQuantitative <- read_csv_file("atlantic_birds/ATLANTIC_BIRDS_quantitative.csv") %>%
  filter(Year_start > 2002) %>%
  select(Record_id, Species, Latitude_y, Longitude_x) %>%
  filter(complete.cases(.)) %>%
  rename(id = Record_id, especie = Species, latitude = Latitude_y, longitude = Longitude_x)

atlanticBirds <- dplyr::bind_rows(
  atlanticBirdsQualitative,
  atlanticBirdsQuantitative
  ) %>%
  dplyr::distinct(
    especie,
    longitude,
    latitude,
    .keep_all = TRUE
    )
```

### Filtrar para a área de estudo

```{r}
atlanticBirdsVetor <- atlanticBirds %>% 
    tidyr::drop_na(longitude, latitude) %>% 
    dplyr::mutate(lon = longitude,
                  lat = latitude) %>% 
    dplyr::filter(lon > -180 & lon < 180) %>% 
    dplyr::filter(lat > -90 & lat < 90) %>% 
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4674)
    
plot(atlanticBirdsVetor$geometry, pch = 20)

CMA_atlanticBirds <- atlanticBirdsVetor[areaAbrangenciaConexao, ] %>% 
  tibble::rowid_to_column()

plot(CMA_atlanticBirds$geometry, pch = 20)
```

```{r}
readr::write_csv(atlanticBirdsQualitative, here("03_dadosDeSaida", "atlanticBirds.csv"))
readr::write_csv(atlanticBirdsQuantitative, here("03_dadosDeSaida", "CMA_atlanticBirds.csv"))
```

## Atlantic Butterflies

```{r}
atlanticButterfliesSites <- read_csv_file2(
  "atlantic_butterflies/ATLANTIC_BUTTERFLIES_sites.csv"
  ) %>%
  select(
    sites_ID,
    Latitude,
    Longitude
    ) %>%
  rename(
    id = sites_ID,
    latitude = Latitude,
    longitude = Longitude
  ) %>%
  filter(complete.cases(.))

atlanticButterfliesSpecies <- read_csv_file2(
  "atlantic_butterflies/ATLANTIC_BUTTERFLIES_species.csv"
  ) %>%
  select(
    sites_ID,
    Species
    ) %>%
  rename(
    id = sites_ID,
    especie = Species
  ) %>%
  filter(complete.cases(.))

atlanticButterflies <- atlanticButterfliesSpecies %>%
  left_join(
    atlanticButterfliesSites, by = "id"
    )
```

### Filtrar para a área de estudo

```{r}
atlanticButterfliesVetor <- atlanticButterflies %>% 
    tidyr::drop_na(longitude, latitude) %>% 
    dplyr::mutate(lon = longitude,
                  lat = latitude) %>% 
    dplyr::filter(lon > -180 & lon < 180) %>% 
    dplyr::filter(lat > -90 & lat < 90) %>% 
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4674)
    
plot(atlanticButterfliesVetor$geometry, pch = 20)

CMA_atlanticButterflies <- atlanticButterfliesVetor[areaAbrangenciaConexao, ] %>% 
  tibble::rowid_to_column()

plot(CMA_atlanticButterflies$geometry, pch = 20)
```

### Exportar arquivos `*.csv`

```{r}
readr::write_csv(atlanticButterflies, here("03_dadosDeSaida", "atlanticButterflies.csv"))
readr::write_csv(atlanticButterflies, here("03_dadosDeSaida", "CMA_atlanticButterflies.csv"))
```

## Atlantic Primates

```{r}
atlanticPrimatesOccurrence <- read_csv_file2(
  "atlantic_primates/ATLANTIC-PR_Occurrence.csv"
  ) %>%
  filter(
    COL_STRT_YR > 2002
    ) %>%
  select(
    ORDEMBD,
    SPECIES,
    LATITUDE_Y,
    LONGITUDE_X
    ) %>%
  rename(
    id = ORDEMBD,
    especie = SPECIES,
    latitude = LATITUDE_Y,
    longitude = LONGITUDE_X
  ) %>%
  filter(complete.cases(.))
```

### Filtrar para a área de estudo

```{r}
atlanticPrimatesVetor <- atlanticPrimatesOccurrence %>% 
    tidyr::drop_na(longitude, latitude) %>% 
    dplyr::mutate(lon = longitude,
                  lat = latitude) %>% 
    dplyr::filter(lon > -180 & lon < 180) %>% 
    dplyr::filter(lat > -90 & lat < 90) %>% 
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4674)
    
plot(atlanticPrimatesVetor$geometry, pch = 20)

CMA_atlanticPrimates <- atlanticPrimatesVetor[areaAbrangenciaConexao, ] %>% 
  tibble::rowid_to_column()

plot(CMA_atlanticPrimates$geometry, pch = 20)
```

### Exportar arquivos `*.csv`

```{r}
readr::write_csv(atlanticPrimatesOccurrence, here("03_dadosDeSaida", "atlanticPrimates.csv"))
readr::write_csv(CMA_atlanticPrimates, here("03_dadosDeSaida", "CMA_atlanticPrimates.csv"))
```

```{r}
# a partir de dados do plano de ação de pequenos felinos
occ_v <- occ %>% 
    tidyr::drop_na(longitude, latitude) %>% 
    dplyr::mutate(lon = longitude,
                  lat = latitude) %>% 
    dplyr::filter(lon > -180 & lon < 180) %>% 
    dplyr::filter(lat > -90 & lat < 90) %>% 
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4674)

    
occ_v <- occ_v %>% filter(
  year > 2002
  ) %>%
  select(
  species,
  latitude,
  longitude
)

mamiferos <- occ_v

mamiferos <- mamiferos[!grepl("sp.", mamiferos$species),]
mamiferos <- mamiferos[!grepl("Panthera onca", mamiferos$species),]
mamiferos <- mamiferos[!grepl("Puma concolor", mamiferos$species),]
mamiferos <- mamiferos[!grepl("Felis catus", mamiferos$species),]
mamiferos <- mamiferos[!grepl("Lynx rufus", mamiferos$species),]
mamiferos <- mamiferos[!grepl("Leopardus guigna", mamiferos$species),]
mamiferos <- mamiferos[!grepl("Leopardus jacobita", mamiferos$species),]
mamiferos$species <- gsub("Puma yagouaroundi","Herpailurus yagouaroundi",
                          mamiferos$species)

CMA_atlanticMammals <- mamiferos[areaAbrangenciaConexao, ] %>% 
  tibble::rowid_to_column()

plot(CMA_atlanticPrimates$geometry, pch = 20)


readr::write_csv(CMA_atlanticMammals , here("03_dadosDeSaida", "CMA_atlanticMammals.csv"))
```

### Filtrar para a área de estudo

```{r}
```

### Integrar e organizar informações

```{r}
dados <- deployments %>%
  dplyr::left_join(
    sequences, by = "deployment_id"
    ) %>%
  # filtrar identificações a nível de espécie
  dplyr::filter(
    !is.na(species)
  ) %>%
  # juntar gênero e espécie para nome científico
  dplyr::mutate(
    especie = paste(genus, species),
    placename = substr(deployment_id, 1,4),
    subproject_name = str_replace(subproject_name, "PAISAGEM ", "L")
  ) %>%
  dplyr::rename(
          ID_Landscape = subproject_name,
          ID_SamplingPoint = placename
          ) %>%
  dplyr::select(
    ID_Landscape, ID_SamplingPoint, everything()
  )
```

```{r}
# Remove unwanted species
species_to_remove <- c(
  "Disparo falso",
  "Não identificado",
  "Disparo falso",
  "Não listado",
  "Chiroptera"
  )
timeLapse <- timeLapse[!timeLapse$Species %in% species_to_remove,]

# Extract IDs from RelativePath column
timeLapse <- timeLapse %>%
  mutate(
    ID_Landscape = substr(RelativePath, 1, 3),
    ID_SamplingPoint = substr(RelativePath, 4, 7)
  ) %>%
  select(ID_Landscape, ID_SamplingPoint, everything()
  )

sort(unique(timeLapse$Species))
```

```{r}
dados <- dados %>%
  # selecionar dados que o Miltinho pediu
  dplyr::select(
    subproject_name, placename,family,especie
    ) %>%
  # agrupar espécies e plotar número de registros
  dplyr::group_by(
    subproject_name, placename, family, especie
    ) %>%
  dplyr::summarise(
    n = n()
    ) %>%
  # filtrar registros não identificados
  dplyr::filter(
    especie != "No CV Result No CV Result"
    ) %>%
  # renomear
  dplyr::rename(
          ID_Paisagem = subproject_name,
          ID_Sitio = placename,
          Familia = family,
          Especie = especie,
          NuRegistros = n)

#checagem
sort(unique(dados$Especie))

sort(unique(dados$ID_Sitio))

dados$Especie <- gsub("Didelphis marsupialis","Didelphis aurita",
                          dados$Especie)

```

### Exportar arquivos `*.csv`

```{r}
readr::write_csv(dados, here("03_dadosDeSaida", "sinteseCamTrapsPELDCCM.csv"))
```
